const FEEDS = [
  "https://www.memeorandum.com/feed.xml",
  "https://www.axios.com/feeds/feed.rss"
];

const TIMED_UPDATES_URL = "https://script.google.com/macros/s/AKfycbyjpdbqmhp_LPC-m_ItmuMEWJRIfyLWdZXKnnCOI9tmT87C6WO-3UjZKaHHUlM9etac/exec";

function onOpen() {
  SpreadsheetApp.getActiveSpreadsheet().addMenu('Newser App', [{name: 'Manual Refresh', functionName: 'fetchDailyHighlights'}]);
}

function fetchDailyHighlights() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("Data");
  let lastFetchTime = sheet.getRange("F1").getValue();

  if (!lastFetchTime || isNaN(new Date(lastFetchTime).getTime())) {
    lastFetchTime = new Date("2024-01-01T00:00:00");
  } else { 
    lastFetchTime = new Date(lastFetchTime); 
  }
  
  const now = new Date();
  if (sheet.getLastRow() > 1) { sheet.deleteRows(2, sheet.getLastRow() - 1); }

  processNews(lastFetchTime, now);
  fetchTimedUpdates(lastFetchTime, now);
  sheet.getRange("F1").setValue(now);
}

function processNews(start, end) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("Data");
  let rawArticles = [];

  FEEDS.forEach(url => {
    try {
      const xml = UrlFetchApp.fetch(url).getContentText();
      const document = XmlService.parse(xml);
      const items = document.getRootElement().getChild("channel").getChildren("item");
      items.forEach(item => {
        let title = item.getChildText("title");
        let link = item.getChildText("link").split('?')[0].split('#')[0];
        const pubDate = new Date(item.getChildText("pubDate"));
        if (pubDate >= start) {
          if (url.toLowerCase().includes("axios.com")) { title = title + " (Axios)"; }
          rawArticles.push({ title, link, pubDate });
        }
      });
    } catch(e) { console.log("RSS Error: " + e); }
  });

  let grouped = [];
  rawArticles.forEach(newArt => {
    let match = grouped.find(ex => isSimilar(newArt.title, ex.title));
    if (match) {
      match.count++;
      match.sources.push({ title: newArt.title, link: newArt.link });
      if (newArt.pubDate > match.pubDate) {
        match.pubDate = newArt.pubDate;
        match.title = newArt.title; 
      }
    } else {
      grouped.push({
        pubDate: newArt.pubDate,
        count: 1,
        title: newArt.title,
        sources: [{ title: newArt.title, link: newArt.link }]
      });
    }
  });

  grouped.sort((a, b) => b.count - a.count || b.pubDate - a.pubDate);
  const output = grouped.map(a => [a.pubDate, a.count, a.title, JSON.stringify(a.sources)]);

  if (output.length > 0) {
    sheet.getRange(sheet.getLastRow() + 1, 1, output.length, 4).setValues(output);
  }
}

function isSimilar(s1, s2) {
  const normalize = s => s.toLowerCase().replace(/[^\w\s]/g, "").split(" ").filter(w => w.length > 3);
  const w1 = normalize(s1), w2 = normalize(s2);
  // Matches if 3 or more significant words are shared [cite: 199]
  return w1.filter(word => w2.includes(word)).length >= 3;
}

function fetchTimedUpdates(start, end) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("Data");
  try {
    const response = UrlFetchApp.fetch(TIMED_UPDATES_URL);
    const items = XmlService.parse(response.getContentText()).getRootElement().getChild("channel").getChildren("item");
    let updates = [];
    items.forEach(item => {
      const pubDate = new Date(item.getChildText("pubDate"));
      if (pubDate >= start) {
        updates.push([pubDate, -1, item.getChildText("title"), item.getChildText("description")]);
      }
    });
    if (updates.length > 0) sheet.getRange(sheet.getLastRow() + 1, 1, updates.length, 4).setValues(updates);
  } catch (e) { console.log("Update Error: " + e); }
}

function doGet() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Data");
  let articles = [];
  if (sheet.getLastRow() > 1) {
    articles = sheet.getRange(2, 1, sheet.getLastRow() - 1, 4).getValues().map(row => ({
      timestamp: row[0], repeats: row[1], title: row[2], link: row[3]
    }));
  }
  return ContentService.createTextOutput(JSON.stringify({
    refreshTime: sheet.getRange("F1").getValue(),
    articles: articles
  })).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  if (e.parameter.action === "refresh") fetchDailyHighlights();
  return ContentService.createTextOutput("Success");
}
