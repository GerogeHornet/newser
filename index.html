<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Newser</title>
    <style>
        :root { --ios-bg: #000000; --ios-card: #1c1c1e; --ios-text: #ffffff; --ios-secondary: #8e8e93; --ios-accent: #0a84ff; --separator: #38383a; --ios-green: #32d74b; }
        body { font-family: -apple-system, sans-serif; background: var(--ios-bg); color: var(--ios-text); margin: 0; padding: env(safe-area-inset-top) 16px 120px 16px; font-size: 17px; }
        body.lock-scroll { overflow: hidden; position: fixed; width: 100%; }
        h1 { margin-bottom: 5px; font-size: 34px; font-weight: 800; }
        #update-display { font-size: 16px; opacity: 0.8; margin-bottom: 20px; font-weight: 400; }
        h2 { font-size: 24px; font-weight: 700; margin: 35px 0 15px 0; display: flex; align-items: center; }
        .count-badge { display: inline-flex; align-items: center; justify-content: center; background-color: #ff3b30; color: white; font-size: 22px; font-weight: 700; min-width: 42px; height: 42px; padding: 0 10px; border-radius: 21px; margin-left: 12px; line-height: 1; box-sizing: border-box; }
        .list-group { border-radius: 14px; overflow: hidden; background: var(--ios-card); margin-bottom: 20px; }
        .list-group > div + div { border-top: 1px solid rgba(0, 0, 0, 0.3); }
        
        /* Article Card Layout */
        .article-card { padding: 22px 18px; display: flex; justify-content: space-between; align-items: center; gap: 12px; }
        .article-content { flex: 1; }
        
        /* Save Circle - Visual State */
        .save-check { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #3a3a3c; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: background 0.2s, border-color 0.2s; cursor: pointer; }
        .save-check.saved { background: var(--ios-green) !important; border-color: var(--ios-green) !important; }
        .save-check svg { width: 18px; height: 18px; fill: none; stroke: white; stroke-width: 3; stroke-linecap: round; stroke-linejoin: round; display: none; pointer-events: none; }
        .save-check.saved svg { display: block !important; }

        .main-headline { font-size: 20px; font-weight: 700; line-height: 1.3; margin-bottom: 10px; color: var(--ios-text); cursor: pointer; }
        .source-row { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .source-badge { background: #ff3b30; color: white; font-size: 12px; font-weight: 800; padding: 4px 8px; border-radius: 6px; text-transform: uppercase; }
        .time-meta { font-size: 14px; color: var(--ios-secondary); font-weight: 500; display: flex; align-items: center; }
        
        /* Footer Tab Bar */
        .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 85px; background: rgba(28, 28, 30, 0.95); backdrop-filter: blur(20px); border-top: 1px solid var(--separator); display: flex; align-items: center; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
        .tab-item { flex: 1; text-align: center; font-size: 18px; font-weight: 600; color: var(--ios-secondary); cursor: pointer; height: 100%; display: flex; align-items: center; justify-content: center; }
        .tab-item.active { color: var(--ios-accent); }
        .tab-divider { width: 1px; height: 40px; background: var(--separator); }

        .btn { padding: 20px; border-radius: 16px; font-size: 20px; font-weight: 700; border: none; cursor: pointer; width: 100%; color: white; margin-top: 30px; }
        .btn-done { background: var(--ios-accent); margin-bottom: 40px; }
        .btn-undo { background: #3a3a3c; border: 1px solid var(--separator); }

        #sheet { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:var(--ios-card); z-index:2000; overflow-y:auto; box-sizing: border-box; }
        .sheet-header { position: sticky; top: 0; background: var(--ios-card); padding: 25px; border-bottom: 1px solid var(--separator); display: flex; justify-content: space-between; align-items: flex-start; z-index: 2001; }
        .sheet-content { padding: 25px; font-size: 24px; line-height: 1.6; white-space: pre-wrap; color: #ffffff; }
        .close-sheet { color: var(--ios-accent); font-size: 22px; font-weight: 700; cursor: pointer; }
    </style>
</head>
<body>
<div id="sheet">
    <div class="sheet-header"><h2 id="sheet-title" style="margin:0; font-size:26px; font-weight:700;"></h2><span class="close-sheet" onclick="closeSheet()">Done</span></div>
    <div id="sheet-body" class="sheet-content"></div>
</div>

<div id="view-now" class="container">
    <h1>Newser</h1>
    <div id="update-display">Connecting...</div>
    <div id="empty-box" style="display:none;">
        <div style="background:#1c1c1e;color:#8e8e93;text-align:center;padding:60px;border-radius:14px;font-size:22px;font-weight:700; border: 1px dashed #38383a;">Empty</div>
        <button id="undo-btn-empty" class="btn btn-undo" style="display:none;" onclick="api('undo')">Undo Done</button>
    </div>
    <div id="content" style="display:none;">
        <section id="death-sec" style="display:none;"><h2>üíÄ Death</h2><div id="death-list" class="list-group"></div></section>
        <section id="notif-sec" style="display:none;"><h2>üí° Notifications</h2><div id="notif-list" class="list-group"></div></section>
        <section id="updates-sec" style="display:none;"><h2>‚ú® Updates</h2><div id="updates-list" class="list-group"></div></section>
        <section id="alerts-sec" style="display:none;"><h2>üö® Alerts</h2><div id="alerts-list" class="list-group"></div></section>
        <section id="trending-sec" style="display:none;"><h2>üî• Trending</h2><div id="trending-list" class="list-group"></div></section>
        <section id="headlines-sec"><h2>üóûÔ∏è Headlines <span id="headline-badge" class="count-badge"></span></h2><div id="headlines-list" class="list-group"></div></section>
        <button id="done-btn-list" class="btn btn-done" onclick="api('clear')">Done for Now</button>
    </div>
</div>

<div id="view-later" class="container" style="display:none;">
    <h1>Later</h1>
    <div id="later-list" class="list-group" style="min-height: 100px;">
        <div style="padding: 40px; text-align: center; color: var(--ios-secondary);">No saved articles.</div>
    </div>
</div>

<div class="tab-bar">
    <div id="tab-now" class="tab-item active" onclick="switchTab('now')">Now</div>
    <div class="tab-divider"></div>
    <div id="tab-later" class="tab-item" onclick="switchTab('later')">Later</div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyLYvUaKUZ2QLz0qFtXnl7fbZ7-EyX9w0HLQ-G2Y5hWqBEPPk0GHzzTjebaHdn4ZVupTA/exec";
    
    function switchTab(tab) {
        document.getElementById('view-now').style.display = tab === 'now' ? 'block' : 'none';
        document.getElementById('view-later').style.display = tab === 'later' ? 'block' : 'none';
        document.getElementById('tab-now').classList.toggle('active', tab === 'now');
        document.getElementById('tab-later').classList.toggle('active', tab === 'later');
    }

    // Toggle save circle green and trigger spreadsheet save
    async function toggleSave(el, title, link, repeats) {
        event.stopPropagation(); // Prevents opening the article when clicking the circle
        if (el.classList.contains('saved')) return; 
        
        el.classList.add('saved'); // Instant visual feedback
        
        const params = `?action=save&title=${encodeURIComponent(title)}&link=${encodeURIComponent(link)}&repeats=${repeats}`;
        try {
            await fetch(API_URL + params); 
        } catch (e) {
            console.error("Save failed", e);
        }
    }

    function closeSheet() { document.getElementById('sheet').style.display = 'none'; document.body.classList.remove('lock-scroll'); }
    
    async function api(a) { 
        document.getElementById('update-display').innerText = "Connecting...";
        document.getElementById('content').style.display = 'none';
